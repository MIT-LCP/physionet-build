{% extends "console/base_console.html" %}

{% block title %}Credential Applications{% endblock %}

{% load console_templatetags %}

{% block content %}
<div class="card">
  <div class="card-header">
    Outstanding credential requests  <span class="badge badge-pill badge-info">{{ applications|length }}</span>
  </div>
  <div class="card-body">
    <div class="tab-content">
      {% if mailto_applications %}
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr class="header">
                <th>#</th>
                <th>User</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Application Date</th>
                <th>Reference Contact Date</th>
                <th>Reference Verification Date</th>
                <th>Process Application</th>
              </tr>
            </thead>
            <tbody>
            {% for application, mailto in mailto_applications %}
              <tr class="header" id='application_{{application.user.email}}'>
                <td>{{forloop.counter}}</td>
                <td><a href="{% url 'public_profile' user.username %}">{{ user }}</td>
                <td>{{ application.user.get_full_name }}</td>
                <td>{{ application.user.email }}</td>
                <td>{{ application.application_datetime|date }}</td>
                <td>{{ application.reference_contact_datetime|date }}</td>
                <td>{{ application.reference_response_datetime|date }}</td>
                <td><a href="#application_{{application.id}}">Process</a></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        {% for application, mailto in mailto_applications %}
          <div class="card mb-4">
            <div class="card-header">
              <h1 style='font-size:25px;' id='application_{{application.id}}'>Process Credential Application - {{ application.user.get_full_name }}</h1>
            </div>
            <div class="card-body">
              <div class='mb-2'>
                <div class="card-columns row">
                  <div class="col-sm-6">
                    <div class="card mb-4">
                      <div class="card-header">
                        Application information
                      </div>
                      <div class="card-body">
                        <div class='mb-2'>
                         {% include "console/application_display_table.html" %}
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-6">
                    <div class="row">
                      <div class="col-sm-12">
                        <div class="card mb-4">
                          <div class="card-header">
                            Contact Reference
                          </div>
                          <div class="card-body">
                            {% if application.reference_contact_datetime %}
                              <p><i class="fas fa-envelope"></i> The reference was contacted on {{ application.reference_contact_datetime }}</p>
                              {% if not application.reference_response_datetime %}
                                <p><i class="fas fa-clock"></i> Awaiting reference response.</p>
                              {% endif %}
                            {% else %}
                              <p>The reference has not been contacted.</p>
                              <a class="btn btn-primary btn-fixed" name="contact_reference" href="{{mailto}}">Contact Reference</a>
                            {% endif %}
                            {# Reference already responded #}
                            {% if application.reference_response_datetime %}
                              <p><i class="fas fa-check" style="color:green"></i> The reference verified the applicant on {{ application.reference_response_datetime }}</p>
                              {% if application.reference_response_text %}
                              <h2 style='font-size:20px;'>Reference comments:</h2>
                              <p style='margin-left:2em'>{{ application.reference_response_text }}</p>
                              {% endif %}
                            {% endif %}
                          </div>
                        </div>
                        <div class="card mb-4">
                          <div class="card-header">
                            Process Application
                          </div>
                          <div class="card-body">
                            <form action="" method="post" class="form-signin">
                              {% csrf_token %}
                              {% include "form_snippet.html" with form=process_credential_form %}
                              <button class="btn btn-primary btn-lg" name="process_application" value="{{application.id}}" type="submit">Submit Response</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}

      {% else %}
        <p><i class="fas fa-check" style="color:green"></i> No applications to show.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
