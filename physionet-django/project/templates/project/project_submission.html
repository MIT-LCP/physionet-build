{% extends "project/project.html" %}

{% block title %}Project Submission - {{ project }}"{% endblock %}

{% load project_templatetags %}

{% block main_content %}

<script>
    // Check whether the project is publishable
    function checkPublishable(){
        $.ajax({url: "{% url 'check_publishable' project.id %}",
                success: function(result){
                    if (result.is_publishable){
                        $("#publishable").html("<i class='fas fa-check' style='color:green'></i> The automatic checks have passed. You may submit the project for review. Note: The project will no longer be editable.");
                        document.getElementById("request-review").disabled = false;
                    }
                    else{
                        message = "<p><i class='fas fa-times' style='color:red'></i> The automatic checks have failed. The following errors must be addressed before you can submit the project:</p><ul>"
                        for (i=0; i<result.publish_errors.length; i++){
                            message += "<li>" + result.publish_errors[i] + "</li>"
                        }
                        message += "</ul>"
                        $("#publishable").html(message);
                    }
                }
        });
    }
</script>


<h2 class="form-signin-heading">Project Submission</h2>
<hr>

<h3>Submission Checklist</h3>

<ol>
    <li>Ensure all <a href="{% url 'project_authors' project.id %}">
        authors</a> to be credited for creating the resource, have been
        added to the project and filled in their details.</li>
    <li>Fill in all the mandatory, and the desired optional
        <a href="{% url 'project_metadata' project.id %}">metadata</a>
        fields.</li>
    <li>Upload the project <a href="{% url 'project_files' project.id %}">
        files</a>.</li>
    <li>Inspect the project <a href="{% url 'project_preview' project.id %}" target="_blank">
        preview</a> to see how the published project would look. Make
        sure to address any errors.</li>
</ol>

<p>For more details, see the <a href="{% url 'author_guidelines' %}" target="_blank">
   author guidelines</a>.</p>

<hr>

<h3>Submission Status</h3>
{% if not project.under_submission %}
    <p>The project is not under submission. If the
       <a href="{% url 'project_preview' project.id %}" target="_blank">
       preview</a> appears satisfactory, the submitting author may
       request a review</p>
    {% if user == project.submitting_author %}
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#submit-modal" onclick="checkPublishable()">
      Request Review
    </button>

    <div class="modal fade" id="submit-modal" tabindex="-1" role="dialog" aria-labelledby="submit-modal" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Submit Project</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form action="" method="post">
            <div class="modal-body">
              {% csrf_token %}
              <p id="publishable"><i class="fas fa-spinner"></i> Running checks on project...</p>
            </div>
            <div class="modal-footer">
              <button id="request-review" class="btn btn-primary" type="submit" name="submit_project" disabled>Request Review</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
{% else %}
    <ul class="list-group">
    <li class="list-group-item"><i class="fas fa-check-circle" style="color:green"></i> The project was submitted for review on {{ submission.presubmission_datetime|date }}.</li>
    {% if submission.submission_status == 1 %}
        </ul>
        <br>
        <div class="card">
            <div class="card-header"><h5>Awaiting co-authors to approve the submission.</h5></div>
                <form action="" method="post">
                    {% csrf_token %}
                <ul class="list-group">
                    {% for author in approved_authors %}
                        <li class="list-group-item">
                            <i class="fas fa-check" style="color:green" title="Approved"></i> {{ author|author_name }}
                            {% if author.user == project.submitting_author %}
                                <span class="badge badge-success">Submitting Author</span>
                            {% endif %}
                            {% if user == author.user %}
                                <button class="btn btn-danger" name="cancel_submission" style="float:right">Cancel Submission</button>
                            {% endif %}
                        </li>
                    {% endfor %}
                    {% for author in unapproved_authors %}
                        <li class="list-group-item">
                            <i class="far fa-clock" title="Waiting for approval"></i> {{ author|author_name }}
                            {% if user == author.user %}
                                <button class="btn btn-primary" name="approve_submission" style="float:right">Approve Submission</button>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
                </form>
        </div>
    {% elif submission.submission_status == 2 %}
        <li class="list-group-item"><i class="far fa-clock"></i> Awaiting an editor to be assigned.</li>
    </ul>
    {% else %}
        <li class="list-group-item"><i class="fas fa-check-circle" style="color:green"></i> The editor of this submission is: <a href="{% url 'public_profile' submission.editor.username %}">{{ submission.editor }}</a> ({{ submission.editor.email }}).</li>
        {% if submission.submission_status == 3 %}
            <li class="list-group-item"><i class="far fa-clock"></i> Awaiting editor response.</li></ul>
        {% elif submission.submission_status == 4 %}
            <p>The editor has requested a resubmission.</p>
        {% elif submission.submission_status == 6 %}
            <li class="list-group-item"><i class="fas fa-check-circle" style="color:green"></i> The editor has accepted the submission. The submitting author may confirm to publish the project.</li></ul>
            {% if user == project.submitting_author %}
                <p>
                    <form action="" method="post">
                        {% csrf_token %}
                        <button class="btn btn-success btn-lg" name="approve_publication"><i class="fas fa-book-open"></i> Publish</button>
                    </form>
                </p>
            {% endif %}
        {% endif %}
    {% endif %}
{% endif %}

<hr>

{% endblock %}
