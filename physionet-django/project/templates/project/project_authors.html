{% extends "project/project.html" %}

{% load static %}

{% load project_templatetags %}

{% block title %}Project Authors{% endblock %}

{% block local_js_top %}
<script type="text/javascript" src="{% static 'custom/js/cookie.js' %}"></script>
{% endblock %}

{% block main_content %}

<script>
  /** Clone a form element to a formset

   @constructor
   @param {string} selector - The selector used to get the element to clone.
   @param {string} form_name - The name of the forms. May be more complicated
   for modelforms, inline_formsets, and genericinline_formsets.
  */
  function cloneFormElement(selector, form_name){
    var newElement = $(selector).clone(true);
    var total_forms = $('#id_' + form_name + '-TOTAL_FORMS').val();

    // Set the names and ids of each input element of the new form
    newElement.find('input').each(function() {
        var name = $(this).attr('name').replace('-' + (total_forms-1) + '-', '-' + total_forms + '-');
        var id = 'id_' + name;
        // What about the actual object id hidden input?
        $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
    });
    // Update the formset total forms indicator
    $('#id_' + form_name + '-TOTAL_FORMS').val(++total_forms);
    // Insert the new content after the original selected content
    $(selector).after(newElement);
  }


  // Add another form to a formset
  function addItem(item, form_name, max_forms){
    var total_forms = parseInt($('#id_' + form_name + '-TOTAL_FORMS').val());

    if (total_forms < max_forms){
      if (total_forms > 0){
        // Clone the existing html
        cloneFormElement("." + item + "-body:last", form_name);
        // Change the number id and display label of the newly cloned element
        new_item_div = document.getElementsByClassName(item + "-body")[total_forms]
        total_forms++;
        new_item_div.id = item + "-" + (total_forms);
        new_item_div.getElementsByClassName(item + "-number")[0].innerHTML = total_forms + "."

      }
      // Reload the item list section with an additional form
      else{
        var csrftoken = getCookie('csrftoken');
        $.ajax({
                type: "POST",
                url: "{% url 'edit_affiliation' project.id %}",
                data: {'csrfmiddlewaretoken':csrftoken,
                       'add_first':true, 'item':item
                },
                success: function reloadSection(result){
                    $("#" + item + "-list").html(result);
                },
        });
      }
    }
  };

  // Delete a form from a formset, and possibly an associated object
  function removeItem(trigger_button, item, form_name){
    // The div encapsulating the entire item element
    var item_div = trigger_button.parentElement.parentElement;
    // The div containing the form input elements
    var form_div = item_div.getElementsByClassName(item + "-form")[0];
    // Get the item instance id if it exists, ie. it is already saved
    for (i=0; i<form_div.children.length; i++) {
      form_input = form_div.children[i];
      if (form_input.id.startsWith('id') && form_input.id.endsWith('id')) {
        var item_instance_id = form_input.value;
      }
    }
    // The object has not been saved. Just edit html.
    if (item_instance_id == ""){
      // The item/form number on the page to be deleted. The div id is
      // {{ item }}-%d
      var item_number = parseInt(item_div.id.substring(item.length + 1));
      var item_list_div = item_div.parentElement;
      var total_forms = item_list_div.getElementsByClassName(item + "-body").length;
      // delete the selected item's html
      item_div.remove()
      // All item forms with greater numbers must be decremented
      for (i=item_number+1; i<total_forms+1; i++){
        var higher_item_div = document.getElementById(item + "-" + i);
        higher_item_div.getElementsByClassName(item + "-number")[0].innerHTML = (i-1) + "."
        higher_item_div.id = item + "-" + (i-1)
      }
      // update the form count
      total_forms--;
      $('#id_' + form_name + '-TOTAL_FORMS').val(total_forms);
    }
    // The item object exists. Send ajax query to remove it and
    // reload the page section.
    else{
      var csrftoken = getCookie('csrftoken');
      $.ajax({
              type: "POST",
              url: "{% url 'edit_affiliation' project.id %}",
              data: {'csrfmiddlewaretoken':csrftoken, 'item':item,
                     'remove_id':item_instance_id
              },
              success: function reloadSection(result){
                  $("#" + item + "-list").html(result);
              },
      });
    }
  };


</script>

<h2 class="form-signin-heading">Project Authors</h2>
<hr>

<p>Each project has one or more <strong>authors</strong>, including the single <strong>submitting author</strong> who creates the project. Authors are credited for creating the resource when it is published.</p>

<p>Authors must be invited and accept authorship, and fill in their own affiliations. Only the submitting author may invite authors, remove authors, and change the final author display order.</p>

<hr>

<script>
  // Ajax call to update authors list
  function moveAuthor(author_id, direction){
      var csrftoken = getCookie('csrftoken');
      $.ajax({
              type: "POST",
              url: "{% url 'move_author' project.id %}",
              data: {'csrfmiddlewaretoken':csrftoken,
                     'author_id':author_id, 'direction':direction
              },
              success: function reloadSection(result){
                  $("#author-list").html(result);
              },
      });
  };
</script>

{% include "project/author_list.html" %}
<br>

<div class="card">
  <div class="card card-header">
    <h4>Outstanding Author Invitations</h4>
  </div>
  {% if invitations %}
  <ul class="list-group list-group-flush">
    {% for invitation in invitations %}
      <li class="list-group-item">
          <strong>Email</strong>: {{ invitation.email }}<br>
            {% if project.submitting_author == user %}
              <a class="float-right">
                  <button class="btn btn-sm" type="button" style="background:none" data-toggle="modal" data-target="#cancel-{{ invitation.id }}-modal"><i class="fas fa-user-times" style="color:#cb2431"></i></button>
              </a>
            {% endif %}
          <strong>Inviter</strong>: {{ invitation.inviter }}<br>
          <strong>Sent</strong>: {{ invitation.request_datetime|date }}
      </li>
    {% endfor %}
  </ul>
  {% else %}
    <div class="card-body text-center">
      <p class="card-text">No outstanding invitations.</p>
    </div>
  {% endif %}
</div>

{% if user == project.submitting_author %}
  <br>
  <h4>Invite Author</h4>
  <form action="{% url 'project_authors' project.id %}" method="post" class="form-signin">
    {% csrf_token %}
    {% include "inline_form_snippet.html" with form=invite_author_form %}
    <button class="btn btn-success btn-fixed" name="invite_author" type="submit">Invite Author</button>
  </form>
{% endif %}
<hr>

{# Modals for removing authors and invitations #}
{% if project.submitting_author == user %}
  {% for author in authors %}
    {% if not author.is_submitting_author %}
      <div class="modal fade" id="remove-{{ author.id }}-modal" role="dialog" aria-labelledby="remove-{{ author.id }}-modal" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Remove Author</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Are you sure you want to remove <strong>{{ author }}</strong> from the project's authors?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <form action="" method="post">
                {% csrf_token %}
                <button class="btn btn-danger" name="remove_author" value="{{ author.id }}" type="submit">Remove Author</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}

  {% for invitation in invitations %}
    <div class="modal fade" id="cancel-{{ invitation.id }}-modal" role="dialog" aria-labelledby="cancel-{{ invitation.id }}-modal" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cancel Invitation</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Are you sure you want to cancel the invitation to <strong>{{ invitation.email }}</strong>?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <form action="" method="post">
              {% csrf_token %}
              <button class="btn btn-danger" name="cancel_invitation" value="{{ invitation.id }}" type="submit">Cancel Invitation</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
{% endif %}
<br>

{% if not admin_inspect %}
  <h4>Your Author Affiliations</h4>
  <p>Set up to three affiliations for your author profile. Note: these fields are not tied to your user profile.</p>
  <form action="{% url 'project_authors' project.id %}" method="post" class="form-signin">
    {% csrf_token %}
    {% include 'project/item_list.html' with item="affiliation" item_label="Affiliations" formset=affiliation_formset max_forms=3 form_name="project-affiliation-content_type-object_id" %}
    <button class="btn btn-primary btn-fixed" name="edit_affiliations" type="submit">Set Affiliations</button>
  </form>
  <hr>
{% endif %}

{% endblock %}
